version: '3.8'

services:
  # --- Base de Datos ---
  db:
    image: mysql:8.0
    container_name: mysql-db
    environment:
      MYSQL_DATABASE: secure_api
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      TZ: America/Argentina/Buenos_Aires
    ports:
      - "33067:3306"
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 5s
      retries: 10

  # --- Tu API Spring Boot ---
  api-service:
    build: .
    container_name: spring-api
    user: root
    ports:
      - "${SERVER_PORT}:${SERVER_PORT}"
    environment:
      - TZ=America/Argentina/Buenos_Aires
      - SPRING_DATASOURCE_URL=jdbc:mysql://db:3306/secure_api?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=${DB_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - SPRING_MAIL_HOST=${MAIL_HOST}
      - SPRING_MAIL_PORT=${MAIL_PORT}
      - SPRING_MAIL_USERNAME=${MAIL_USER}
      - SPRING_MAIL_PASSWORD=${MAIL_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - LOGGING_FILE_NAME=/app/logs/app.log 
    volumes:
      - ./logs:/app/logs
    depends_on:
      db:
        condition: service_healthy

  # --- LOKI (Almac√©n de logs) ---
  loki:
    image: grafana/loki:latest
    container_name: loki
    environment:
      - TZ=America/Argentina/Buenos_Aires
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml

  # --- PROMTAIL (Recolector de logs) ---
  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    environment:
      - TZ=America/Argentina/Buenos_Aires
    volumes:
      - ./logs:/var/log/app
      - ./promtail-config.yaml:/etc/promtail/config.yaml
    command: -config.file=/etc/promtail/config.yaml
    depends_on:
      - loki

  # --- MONITOREO ---
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    environment:
      - TZ=America/Argentina/Buenos_Aires
    volumes:
      - ./prometheus_config/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    depends_on:
      - api-service

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - TZ=America/Argentina/Buenos_Aires
      - GF_DATE_FORMATS_USE_BROWSER_LOCALE=true
    depends_on:
      - prometheus
      - loki